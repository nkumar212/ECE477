<html>
<head>

<link rel="stylesheet" type="text/css" href="index.css"/>

<script>

//Constants
var KEY_W = 1;
var KEY_A = 2;
var KEY_S = 4;
var KEY_D = 8;
var KEY_SPACE = 16;
var KEY_F12 = 32; //Declared this earlier than the reset
var KEY_F1 = 64;
var KEY_F2 = 128;
var KEY_F3 = 256;
var KEY_F4 = 512;
var KEY_F5 = 1024;
var KEY_F6 = 2048
var KEY_F7 = 4096;

var ws = new WebSocket("ws://128.46.100.114:9999/");

//Global variable holding which gKeys are down
var gKeys = 0;
var msgInfo = new Object();

ws.onmessage = function(jmsg) {
	msg = JSON.parse(msgInfo);
	switch(msg['command'])
	{
		case 0x30:
			$("#metricsbox").text(jmsg);
			break;
	}
}

ws.onopen = function() {

	ws.send('Hello from the client!');
	
	document = document.getElementById("canvas");
	output = document.getElementById("output");

	document.onload = function(){
		gKeys = 0;
	}

	document.onfocus = function(){
		gKeys = 0;
	}

	document.onblur = function(){
		gKeys = 0;
	}

	document.onkeyup = function(e){
		if(e == null) e = window.event;
		key = e.keyCode;

		if(key == 65) //A
			gKeys &= 0xFFFF ^ KEY_A
		else if(key == 83) //S
			gKeys &= 0xFFFF ^ KEY_S
		else if(key == 68) //D
			gKeys &= 0xFFFF ^ KEY_D
		else if(key == 87) //W
			gKeys &= 0xFFFF ^ KEY_W
		else if(key == 32) //Space
			gKeys &= 0xFFFF ^ KEY_SPACE
		else if(key == 112) //Set Camera to X depth
			gKeys &= 0xFFFF ^ KEY_F1
		else if(key == 113) //Set Camera to Y depth
			gKeys &= 0xFFFF ^ KEY_F2
		else if(key == 114) //Set Camera to Z depth
			gKeys &= 0xFFFF ^ KEY_F3
		else if(key == 115) //Set Camera to XYZ Rainbow
			gKeys &= 0xFFFF ^ KEY_F4
		else if(key == 116) //Set Camera to Walls Mode
			gKeys &= 0xFFFF ^ KEY_F5
		else if(key == 117) //Set Camera to Walls Mode
			gKeys &= 0xFFFF ^ KEY_F6
		else if(key == 118) //Set Camera to Walls Mode
			gKeys &= 0xFFFF ^ KEY_F7
		else if(key == 123) //Save Camera to file
			gKeys &= 0xFFFF ^ KEY_F12
		else
			return true;

		return false;
	}

	document.onkeydown = function(e){
		if(e == null) e = window.event;
		key = e.keyCode;

		if(key == 65) //A
			gKeys |= KEY_A
		else if(key == 83) //S
			gKeys |= KEY_S
		else if(key == 68) //D
			gKeys |= KEY_D
		else if(key == 87) //W
			gKeys |= KEY_W
		else if(key == 32) //Space
			gKeys |= KEY_SPACE
		else if(key == 112) //Set Camera to X depth
		{
			gKeys |= KEY_F1
			document.getElementById("cam_mode").innerHTML="X Depth";
		}
		else if(key == 113) //Set Camera to Y depth
		{
			gKeys |= KEY_F2
			document.getElementById("cam_mode").innerHTML="Y Depth";
		}
		else if(key == 114) //Set Camera to Z depth
		{
			gKeys |= KEY_F3
			document.getElementById("cam_mode").innerHTML="Z Depth";
		}
		else if(key == 115) //Set Camera to XYZ Rainbow
		{
			gKeys |= KEY_F4
			document.getElementById("cam_mode").innerHTML="XYZ Depth Rainbow";
		}
		else if(key == 116) //Set Camera to Walls Mode
		{
			gKeys |= KEY_F5
			document.getElementById("cam_mode").innerHTML="Walls";
		}
		else if(key == 117) //Save Camera to file
		{
			gKeys |= KEY_F6
			document.getElementById("cam_mode").innerHTML="MAP";
		}
		else if(key == 118) //Save Camera to file
		{
			gKeys |= KEY_F7
			document.getElementById("cam_mode").innerHTML="RGB";
		}
		else if(key == 123) //Save Camera to file
			gKeys |= KEY_F12
		else
			return true;

		if(document.activeElement.tagName.toLowerCase() == 'input')
			return true;
		else
			return false;
	}

	function getKeys(){
		setTimeout(function() {
			msgInfo.command=document.getElementById("command").value;
			msgInfo.gKeys=gKeys;
			msgInfo.speed=document.getElementById("speedslider").value;
			msgInfo.robotid=document.getElementById("username").value;
			msgInfo.sessionid=document.getElementById("sessionid").value;

			msg = JSON.stringify(msgInfo);
			output.value = msg 
			ws.send(msg);
		
			getKeys();
		},10);
	}

	getKeys();
}

</script>
</head>
<body>
	<!--HEADER -->
	<div class="header">
	<h1 id="header_text">Project Minotaur Command and Control Page</h1>
	
	</div>

	<table id="main_section" cellpadding="15">
		<tr>
		<td id="settings_box">
			<table class="settings_table">
			<caption class="header">Robot Status and Settings</caption>
			<tr>
					<td class="label">Status</td>
					<td class="value"><span id="status" style="color:red">Offline</span></td>
			</tr>
			<tr>
					<td class="label">Battery Percentage</td>
					<td class="value"><span id="battery" style="color:green">100%</span></td>
			</tr>
					<tr>
					<td class="label">Speed</td>
					<td class="value"><span id="speed" style="color:#008080">100</span></td>
			</tr>	
			
			<tr><td colspan="2">----------------------------------------------------------------</td></tr>

			<tr>


					<td class="label">Email To Alert</td>
					<td class="value"><input type="text" name="email"></td>
			</tr>		<tr>
					<td class="label">Camera Mode</td>
					<td class="value"><p id="cam_mode" style="color:orange">RGB</p></td>
				
			</tr>
			<tr>
					<td class="label">Drive Mode</td>
					<td class="value"><form action="">
							<input type="radio" name="drive_mode" value="patrol">Patrol</input>
							<input type="radio" name="drive_mode" value="manual">Manual</input></form>
					</td>
			</tr>
			<tr>
					<td></td>
					<td class="value"><input type="button" value="Save Settings"/></td>
			</tr>	

			</table>
			
		</td>

		<td id=video_stream">
			
			<embed type="application/x-vlc-plugin" pluginspage="http://www.videolan.org" width="320" height="240" id="vlc" loop="yes" autoplay="yes" target="test.ogg"></embed>
			<object classid="clsid:9BE31822-FDAD-461B-AD51-BE1D1C159921" codebase="http://download.videolan.org/pub/videolan/vlc/last/win32/axvlc.cab"></object>	
			<!--
			<video id="video_stream" style="background-color:white;border: thin red solid;" width=320 height=240>
				<source src="rtp://128.46.100.114:50001/test1.ogg" type="video/ogg" />	
				</video>	-->
		</td>
		</tr>

		<tr>
			<td colspan="2" id="directions"><p>Welcome to the command and control page for Project Minotaur! Press the patrol button to have the robot automatically patrol the room and search for intruders. If it finds one the email specified will be alerted with a picture of the intruder. To drive the robot, press the 'Manual' radio button and use the following keys:
				   			<table id="key_mappings" border="3" cellpadding="5px">
								<tr><td>W</td> <td>Forward</td></tr>
								<tr><td>A</td> <td>Left</td></tr>
								<tr><td>S</td> <td>Backwards</td></tr>
								<tr><td>D</td> <td>Right</td></tr>
								<tr><td>Space</td> <td>Stop</td></tr>
								<tr><td>Up Arrow</td> <td>Increase Speed</td></tr>
								<tr><td>Down Arrow</td> <td>Decrease Speed</td></tr>
						</ul>
			</td>	
		</tr>

		<tr><!--
		<td colspan="2" id="button_box">
			<input class="command_button" type="button" width=70px height=40px value="Drive Robot"/>
			<input class="command_button" type="button" width=70px height=40px value="Patrol Room"/>
	</td>
	-->
		</tr>
	</table>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>
		<br>




		<canvas tabindex=1 style="background-color:white;border: thin red solid;" width=320 height=240 id="canvas"></canvas>
		<video id="video_stream" style="background-color:white;border: thin red solid;" width=320 height=240>
			<source src="rtp://128.46.100.114:50001/test1.ogg" type="video/ogg" />	
		</video>
		
		<input type="hidden" id="robotid" value="MINOTAUR_1" />
		<input type="hidden" id="sessionid" value="127.0.0.1" />
		<input type="hidden" id="command" value="0" />
		
		<br>Username:<input type="text" id="username"/>
		<br>Speed:<input type="range" id="speedslider" min="0" max="100"/>
		<br>Outdata:<textarea id="output" cols=80 rows=5></textarea>
		<br>Metrics:<textarea id="metricsbox" cols=80 rows=5></textarea>

	</div>
</body>
</html>
